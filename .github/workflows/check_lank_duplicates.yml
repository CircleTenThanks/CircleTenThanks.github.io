name: Check Lank Duplicates and Commit

on:
  push:
    paths:
      - '_data/songs.csv'  # _data/songs.csvãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹

jobs:
  check_and_commit:
    runs-on: ubuntu-latest
    steps:
    
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      # 4. CSVãƒ•ã‚¡ã‚¤ãƒ«ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
      - name: Check for duplicates in 'lank' column
        run: |
          echo "
          import pandas as pd

          # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
          df = pd.read_csv('_data/songs.csv')

          # é‡è¤‡ã™ã‚‹'lank'ã®å€¤ã‚’æ¤œå‡ºï¼ˆç©ºå€¤ã‚’é™¤å¤–ï¼‰
          duplicated_lanks = df[df['lank'].notna()]['lank'].duplicated(keep=False)
          
          if duplicated_lanks.any():
              # é‡è¤‡ãŒã‚ã‚‹å€¤ã®ã¿ã‚’å‡¦ç†
              for lank_value in df[duplicated_lanks]['lank'].unique():
                  mask = df['lank'] == lank_value
                  df.loc[mask, 'lank'] = [f'{lank_value}_{i}' for i in range(sum(mask))]

              # ä¿®æ­£å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVã¨ã—ã¦ä¿å­˜
              df.to_csv('_data/songs.csv', index=False)
              print('Duplicates found and resolved.')
          else:
              print('No duplicates found in the lank column.')
          " > check_duplicates.py
          python check_duplicates.py

      # 5. ä¿®æ­£ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ
      - name: Commit changes
        run: |
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
          branch_name="fix/duplicate-lanks-$(date +%Y%m%d-%H%M%S)"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b $branch_name
          
          git add _data/songs.csv
          git commit -m "Fix: Resolve duplicate 'lank' values"
          git remote set-url origin https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin $branch_name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'ğŸ¤– é‡è¤‡ã™ã‚‹lankå€¤ã®ä¿®æ­£'
          body: |
            é‡è¤‡ã™ã‚‹lankå€¤ã‚’è‡ªå‹•çš„ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
          branch: $branch_name
          base: main
          labels: automated-pr, duplicate-fix

