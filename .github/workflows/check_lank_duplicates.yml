name: Check Lank Duplicates and Commit

on:
  push:
    paths:
      - '_data/songs.csv'  # _data/songs.csvãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹

jobs:
  check_and_commit:
    runs-on: ubuntu-latest
    steps:
    
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 3. å¿…è¦ãªPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      # 4. CSVãƒ•ã‚¡ã‚¤ãƒ«ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
      - name: Check for duplicates in 'lank' column
        run: |
          if [ -f .github/scripts/check_duplicates.py ]; then
            python .github/scripts/check_duplicates.py
            if [ $? -eq 0 ]; then  # é‡è¤‡ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã«å‡¦ç†ã‚’ç¶šè¡Œ
              echo "é‡è¤‡ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
              exit 0
            fi
          else
            echo "check_duplicates.pyãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚"
            exit 1
          fi

      # 5. ä¿®æ­£ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒŸãƒƒãƒˆ
      - name: Commit changes
        run: |
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
          branch_name="fix/duplicate-lanks-$(date +%Y%m%d-%H%M%S)"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b $branch_name
          
          git add _data/songs.csv
          git commit -m "Fix: Resolve duplicate 'lank' values"
          git remote set-url origin https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git push origin $branch_name
          rm check_duplicates.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'ğŸ¤– é‡è¤‡ã™ã‚‹lankå€¤ã®ä¿®æ­£'
          body: |
            é‡è¤‡ã™ã‚‹lankå€¤ã‚’è‡ªå‹•çš„ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
          branch: $branch_name
          base: main
          labels: automated-pr, duplicate-fix

